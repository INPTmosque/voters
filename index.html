<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ஐஎன்பிடி வாக்காளர் விவரம்</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .data-table-container {
            max-height: 70vh; 
            overflow: auto; 
            -webkit-overflow-scrolling: touch;
        }
        /* Style for Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        /* Disabled button style */
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-4 sm:p-8">
        <header class="mb-6 border-b pb-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-800 text-center">INPT வாக்காளர் பட்டியல்</h1>
            <p class="text-center text-grey-300 mt-1">விவரங்களைப் பார்க்க, தேட வகையரா/மொபைல் எண்/முகவரியை உள்ளீடு செய்ய</p>
            //<p class="text-right text-yellow-700 mt-1" style="font-size: 10px;">-- உருவாக்கம் : சிக்கந்தர் பாட்சா</p>

        </header>

        <div class="mb-6 p-4 bg-blue-50 rounded-lg shadow-inner">
            <label for="search-input" class="block text-lg font-semibold text-blue-600 mb-2">தேடல் (பெயர், திருமணமான தேதி அல்லது வருடம்)</label>
            <input type="text" id="search-input" placeholder="பெயர்/தேதி DD-MM-YYYY/ஆண்டு"
                   class="w-full p-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-540 transition"
                   oninput="filterRecords()">
        </div>

        <div id="status-message" class="text-center p-3 mb-4 text-sm font-medium text-gray-600 bg-yellow-100 rounded-lg hidden">
            தரவு ஏற்றப்படுகிறது...
        </div>

        <div class="data-table-container" id="data-container">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-blue-50 sticky top-0 shadow-sm z-10">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">வரிசை எண்</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">பெயர்</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">தந்தை பெயர்</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">வகையரா</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">திருமணமான தேதி</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider hidden lg:table-cell">திருமணமான வருடம்</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">திருமணத்தின் போது வயது</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">தற்போதைய வயது</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">மொபைல் நம்பர்</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">முகவரி</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">செயல்</th>
                    </tr>
                </thead>
                <tbody id="voter-details-body" class="bg-white divide-y divide-gray-100">
                    </tbody>
            </table>
            
            <div id="no-results" class="text-center py-12 text-gray-500 text-xl hidden">
                தேடலுக்கு ஏற்ற பதிவுகள் எதுவும் இல்லை.
            </div>

            <div id="user-info" class="text-sm text-gray-400 mt-6 pt-4 border-t border-gray-200">
                <p>பயனர் ID: <span id="current-user-id">இல்லை</span></p>
                <p class="text-xs text-red-500 mt-1">தரவைப் பதிவேற்ற, உங்கள் கணினியில் உள்ள Node.js ஸ்கிரிப்டைப் பயன்படுத்தவும்.</p>
            </div>
        </div>
    </div>
    
    <div id="update-modal" class="modal-overlay hidden">
        <div class="modal-content bg-white rounded-xl shadow-3xl p-6 relative">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4 border-b pb-2">தொடர்பு விவரம் பதிய</h2>
            
            <form id="update-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">வாக்காளர் பெயர் (பார்வை மட்டும்):</label>
                    <p id="update-name" class="text-lg font-semibold text-gray-900 bg-gray-50 p-2 rounded-lg"></p>
                    <input type="hidden" id="update-serial-no">
                    <input type="hidden" id="update-doc-id"> </div>
                
                <div id="modal-status-message-top" class="text-center p-3 mb-4 text-sm font-medium rounded-lg hidden"></div>
                
                <div class="mb-4">
                    <label for="update-relation" class="block text-sm font-medium text-gray-700 mb-1">வகையரா <span class="text-red-500">*</span></label>
                    <input type="text" id="update-relation" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>

                <div class="mb-4">
                    <label for="update-mobile" class="block text-sm font-medium text-gray-700 mb-1">மொபைல் நம்பர் <span class="text-red-500">*</span></label>
                    <input type="tel" id="update-mobile" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>

                <div class="mb-6">
                    <label for="update-address" class="block text-sm font-medium text-gray-700 mb-1">முகவரி <span class="text-red-500">*</span></label>
                    <textarea id="update-address" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-none" required></textarea>
                </div>
                
                <div id="modal-status-message-bottom" class="text-center p-3 mb-4 text-sm font-medium rounded-lg hidden"></div>

                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeUpdateModal()" class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition duration-300">
                        ரத்துசெய்யவும்
                    </button>
                    <button type="submit" id="save-button" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-300 shadow-md">
                        சேமிக்கவும்
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, onSnapshot, updateDoc, getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('debug');

        // ------------------------------------------------------------------------------------------
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD5zu1YkYTy5AAGzs8tOVU4Mz5ZLxf87GE", 
            authDomain: "inptvotersdata.firebaseapp.com",
            projectId: "inptvotersdata", 
            storageBucket: "inptvotersdata.appspot.com",
            messagingSenderId: "772536734950",
            appId: "1:772536734950:web:8bc150658df00dc86c9727"
        };
        // ------------------------------------------------------------------------------------------

        let db;
        let auth;
        let globalRecords = [];
        let currentUserId = null;
        
        // FIX: Collection Name now points to the root collection where data is actually stored
        const COLLECTION_NAME = 'voterRecords'; 

        // DOM elements
        const statusMessageEl = document.getElementById('status-message');
        const voterDetailsBody = document.getElementById('voter-details-body');
        const noResultsEl = document.getElementById('no-results');
        const currentUserIdEl = document.getElementById('current-user-id');
        const updateModal = document.getElementById('update-modal');
        const updateForm = document.getElementById('update-form');
        const updateNameEl = document.getElementById('update-name');
        const updateSerialNoEl = document.getElementById('update-serial-no');
        const updateDocIdEl = document.getElementById('update-doc-id'); // NEW
        const updateRelationEl = document.getElementById('update-relation');
        const updateMobileEl = document.getElementById('update-mobile');
        const updateAddressEl = document.getElementById('update-address');
        const saveButtonEl = document.getElementById('save-button');
        const modalStatusTopEl = document.getElementById('modal-status-message-top');
        const modalStatusBottomEl = document.getElementById('modal-status-message-bottom');

        // Helper function for styling read-only fields
        function toggleReadOnlyStyles(element, isReadOnly) {
            element.readOnly = isReadOnly;
            element.classList.toggle('bg-gray-100', isReadOnly);
            element.classList.toggle('bg-white', !isReadOnly);
        }

        // --- Utility Functions ---

        function showStatus(message, isError = false, element = statusMessageEl) {
            element.textContent = message;
            element.className = isError 
                ? 'text-center p-3 mb-4 text-sm font-medium text-red-700 bg-red-100 rounded-lg'
                : 'text-center p-3 mb-4 text-sm font-medium text-gray-600 bg-yellow-100 rounded-lg';
            element.classList.remove('hidden');
        }

        function hideStatus(element = statusMessageEl) {
            element.classList.add('hidden');
        }

        // FIX: Function now returns a Collection Reference to 'voterRecords'
        function getCollectionRef() {
            return collection(db, COLLECTION_NAME);
        }
        
        // --- Firebase Core Initialization and Data Listener ---

        async function initFirebase() {
            // Check if the placeholder config was replaced (no longer checking for 'YOUR_PROJECT_ID' but ensuring the values look real)
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey.length < 30) { 
                showStatus("⛔ பிழை: Firebase API விசை காணப்படவில்லை அல்லது தவறாக உள்ளது.", true);
                return;
            }

            try {
                showStatus("அங்கீகாரம் மற்றும் தரவுத்தளம் ஏற்றப்படுகிறது...");
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 1. Authenticate (Anonymous Sign-in)
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            currentUserId = user.uid;
                        } else {
                            try {
                                await signInAnonymously(auth); 
                                currentUserId = auth.currentUser.uid;
                            } catch (error) {
                                console.error("Authentication Error:", error);
                                showStatus("அங்கீகார பிழை: தரவை அணுக முடியவில்லை.", true);
                                currentUserId = 'anonymous-error';
                            }
                        }
                        currentUserIdEl.textContent = currentUserId;
                        unsubscribe(); 
                        resolve();
                    });
                });
                
                // 2. Setup Data Listener
                setupDataListener();

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showStatus(`Firebase துவக்கப் பிழை: ${error.message}`, true);
            }
        }

        // FIX: The data listener now uses onSnapshot with a Collection Reference
        function setupDataListener() {
            if (!db || !currentUserId) {
                console.log("Database or User ID not ready for listener.");
                return;
            }

            const collectionRef = getCollectionRef();
            
            // Listen to the entire collection
            onSnapshot(collectionRef, (querySnapshot) => {
                const records = [];
                // Iterate through each document in the collection
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    records.push({
                        // Store the Firestore Document ID, which is needed for updates
                        docId: doc.id, 
                        // Map fields to expected front-end structure
                        serialNo: Number(data.serialNo) || 0,
                        name: String(data.name || ''),
                        fatherName: String(data.fatherName || ''),
                        relation: String(data.relation || ''),
                        marriageDate: String(data.marriageDate || ''),
                        marriageYear: String(data.marriageYear || ''),
                        ageAtMarriage: Number(data.ageAtMarriage) || 0,
                        currentAge: Number(data.currentAge) || 0,
                        mobileNo: String(data.mobileNo || ''), 
                        address: String(data.address || '')
                    });
                });

                globalRecords = records.sort((a, b) => a.serialNo - b.serialNo);
                
                if (globalRecords.length > 0) {
                    filterRecords();
                    hideStatus();
                } else {
                    filterRecords();
                    // Show the specific error for no records found
                    showStatus("வாக்காளர் பதிவுகள் எதுவும் கிடைக்கவில்லை. தரவைப் பதிவேற்றவும்.", true);
                }
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                showStatus(`தரவு ஏற்றத்தில் பிழை: ${error.message}`, true);
            });
        }
        
        // --- Modal and Update Logic ---
        
        /**
         * Sets the state of the modal elements. Locks individual fields if data exists.
         * @param {Object} record - The current voter record.
         */
        function setUpdateModalState(record) {
            const mobileExists = record.mobileNo.trim() !== '';
            const addressExists = record.address.trim() !== '';
            const relationExists = record.relation.trim() !== ''; 
            
            // 1. Lock individual fields if data exists and apply styles
            toggleReadOnlyStyles(updateRelationEl, relationExists);
            toggleReadOnlyStyles(updateMobileEl, mobileExists);
            toggleReadOnlyStyles(updateAddressEl, addressExists);

            // 2. Check if ALL fields are complete (locked)
            const dataComplete = mobileExists && addressExists && relationExists; 

            if (dataComplete) {
                // All fields are filled and locked -> Disable save button
                saveButtonEl.disabled = true;
                saveButtonEl.classList.add('btn-disabled');
                showStatus("அனைத்துத் தொடர்பு விவரங்களும் ஏற்கனவே பதியப்பட்டுவிட்டன. புதுப்பிக்க முடியாது.", true, modalStatusTopEl);
            } else {
                // At least one field is empty/editable -> Enable save button
                saveButtonEl.disabled = false;
                saveButtonEl.classList.remove('btn-disabled');
                hideStatus(modalStatusTopEl);
            }
        }
        
        window.openUpdateModal = function(serialNo) {
            // FIX: Find the record by serialNo (which is what the button passes)
            const record = globalRecords.find(r => r.serialNo === serialNo);
            
            if (!record) {
                showStatus(`பதிவு எண் ${serialNo} காணப்படவில்லை.`, true);
                return;
            }

            // Populate modal fields
            updateNameEl.textContent = record.name;
            updateSerialNoEl.value = serialNo;
            updateDocIdEl.value = record.docId; // NEW: Store the Doc ID
            updateRelationEl.value = record.relation; 
            updateMobileEl.value = record.mobileNo;
            updateAddressEl.value = record.address;
            
            // Set the disabled/enabled state based on existing data
            setUpdateModalState(record);
            
            // Ensure bottom status is hidden
            hideStatus(modalStatusBottomEl);
            updateModal.classList.remove('hidden');
        }

        window.closeUpdateModal = function() {
            updateModal.classList.add('hidden');
            updateForm.reset();
        }

        updateForm.onsubmit = function(event) {
            event.preventDefault();
            // Only attempt to save if the button is NOT disabled
            if (!saveButtonEl.disabled) {
                saveUpdatedRecord();
            } else {
                 showStatus("இந்த விவரங்களை உங்களால் புதுப்பிக்க முடியாது. அனைத்தும் பூட்டப்பட்டுள்ளன.", true, modalStatusTopEl);
            }
        }

        // FIX: Updated logic to update a single document by its ID
        async function saveUpdatedRecord() {
            hideStatus(modalStatusBottomEl);
            
            const docId = updateDocIdEl.value; // Get the Firestore Document ID
            
            // Validation (Unchanged)
            if (!updateRelationEl.readOnly && !updateRelationEl.value.trim()) {
                showStatus("வகையரா கட்டாயம் நிரப்பப்பட வேண்டும்.", true, modalStatusBottomEl);
                return;
            }
            if (!updateMobileEl.readOnly && !updateMobileEl.value.trim()) {
                showStatus("மொபைல் நம்பர் கட்டாயம் நிரப்பப்பட வேண்டும்.", true, modalStatusBottomEl);
                return;
            }
            if (!updateAddressEl.readOnly && !updateAddressEl.value.trim()) {
                showStatus("முகவரி கட்டாயம் நிரப்பப்பட வேண்டும்.", true, modalStatusBottomEl);
                return;
            }

            // Get current record from local state (by docId) to check for changes
            const currentRecord = globalRecords.find(r => r.docId === docId);

            const updatedData = {
                relation: updateRelationEl.value.trim(), 
                mobileNo: updateMobileEl.value.trim(),
                address: updateAddressEl.value.trim(),
                lastUpdatedOn: new Date().toISOString()
            };
            
            // Simplified change check based on the fields we are updating
            const changesDetected = 
                currentRecord.relation !== updatedData.relation ||
                currentRecord.mobileNo !== updatedData.mobileNo ||
                currentRecord.address !== updatedData.address;

            if (!changesDetected) {
                showStatus("எந்த மாற்றங்களும் செய்யப்படவில்லை.", false, modalStatusBottomEl);
                setTimeout(closeUpdateModal, 1000);
                return;
            }
            
            showStatus("தரவு சேமிக்கப்படுகிறது...", false, modalStatusBottomEl);
            
            const docRef = doc(db, COLLECTION_NAME, docId);

            try {
                // Use updateDoc to modify the fields on the specific document
                await updateDoc(docRef, updatedData);

                showStatus("தொடர்பு விவரங்கள் வெற்றிகரமாகப் புதுப்பிக்கப்பட்டன!", false, modalStatusBottomEl);
                
                // Close modal (Firestore listener will automatically update the table)
                setTimeout(() => {
                    closeUpdateModal();
                }, 1500);

            } catch (error) {
                console.error("Firestore Update Error:", error);
                showStatus(`சேமிப்பில் பிழை ஏற்பட்டது: ${error.message}`, true, modalStatusBottomEl);
            }
        }

        // --- Filtering and Rendering Logic (Unchanged) ---

        window.filterRecords = function() {
            const searchInput = document.getElementById('search-input').value.trim().toLowerCase();
            
            let filteredRecords = globalRecords;

            if (searchInput) {
                filteredRecords = globalRecords.filter(record => {
                    // Check if the record fields are available before calling includes()
                    const nameMatch = record.name && record.name.toLowerCase().includes(searchInput);
                    const dateMatch = record.marriageDate && record.marriageDate.toLowerCase().includes(searchInput);
                    const yearMatch = record.marriageYear && record.marriageYear.toString().includes(searchInput);

                    return nameMatch || dateMatch || yearMatch;
                });
            }
            
            renderTable(filteredRecords);
        }

        function renderTable(records) {
            voterDetailsBody.innerHTML = '';
            
            if (records.length === 0) {
                noResultsEl.classList.remove('hidden');
                return;
            }

            noResultsEl.classList.add('hidden');

            records.forEach(record => {
                const row = voterDetailsBody.insertRow();
                row.className = 'hover:bg-blue-50 transition duration-150 ease-in-out';
                
                // Data for each cell (order matches table headers)
                const dataFields = [
                    record.serialNo,
                    record.name,
                    record.fatherName,
                    record.relation,
                    record.marriageDate,
                    record.marriageYear,
                    record.ageAtMarriage,
                    record.currentAge,
                    record.mobileNo,
                    record.address
                ];

                dataFields.forEach((field, index) => {
                    const cell = row.insertCell();
                    cell.textContent = field || '';
                    cell.className = 'px-3 py-2 whitespace-nowrap text-sm text-gray-700';
                    
                    // Apply hidden classes for responsiveness
                    if (index === 5) cell.classList.add('hidden', 'lg:table-cell'); // Marriage Year
                });
                
                // Action Button Cell
                const actionCell = row.insertCell();
                actionCell.className = 'px-3 py-2 whitespace-nowrap text-sm font-medium';
                actionCell.innerHTML = `
                    <button onclick="openUpdateModal(${record.serialNo})" 
                            class="bg-green-500 text-white p-2 text-xs rounded-lg shadow-sm hover:bg-green-600 transition duration-150 transform hover:scale-105">
                        விவரங்கள் சேர்க்க
                    </button>
                `;
            });
        }

        window.onload = initFirebase;
    </script>
</body>
</html>














