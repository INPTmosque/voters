<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>роРроОройрпНрокро┐роЯро┐ ро╡ро╛роХрпНроХро╛ро│ро░рпН ро╡ро┐ро╡ро░роорпН</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* тмЗя╕П NEW: Lock scrolling on the main window тмЗя╕П */
        html, body {
            height: 100%;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
       
        .data-table-container {
            max-height: 75vh; 
            overflow-y: auto; 
            /* тмЗя╕П NEW: Allow horizontal scroll тмЗя╕П */
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch;
        }


        /* Style for Modal Overlay (Used for both update and new percentage modal) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        /* Disabled button style */
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* ------------------------------------------------------------- */
        /* тмЗя╕П NEW: STYLES FOR INTRO PERCENTAGE MODAL тмЗя╕П */
        /* Note: .modal-overlay and .modal-content are reused/overridden */
        
        .intro-modal-content {
            background-color: #fefefe;
            margin: 15% auto; 
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 400px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .percentage-display {
            padding: 15px;
            background-color: #e6f7ff;
            border-radius: 5px;
            margin-bottom: 25px;
            border: 1px solid #91d5ff;
        }

        .percentage-display p {
            margin: 5px 0;
            color: #333;
        }

        .percent-value {
            font-size: 2em;
            font-weight: bold;
            color: #0056b3;
        }

        .modal-button {
            background-color: #28a745; /* Green color for continue */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s;
        }

        .modal-button:hover {
            background-color: #1e7e34;
        }
        /* тмЖя╕П END NEW STYLES тмЖя╕П */
        /* ------------------------------------------------------------- */
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="voterInfoModal" class="modal-overlay">
        <div class="intro-modal-content">
            <h3>ЁЯУК родро░ро╡рпБ рокрпБродрпБрокрпНрокро┐рокрпНрокрпБ роиро┐ро▓рпИ (Data Update Status)</h3>
            
            <div class="percentage-display">
                <p>
                    родрпКроЯро░рпНрокрпБ ро╡ро┐ро╡ро░роорпН рокродро┐ро╡рпБ роЪрпЖропрпНрод ро╡ро╛роХрпНроХро╛ро│ро░рпНроХро│рпН:
                </p>
                <p class="percent-value">
                    <span id="modal-percent">...%</span> </p>
            </div>
            
            <button id="closeModalBtn" class="modal-button">
                родрпКроЯро░ро╡рпБроорпН (Continue)
            </button>
        </div>
    </div>
    
    <div id="mainContent" style="display: none;"> 
        <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-4 sm:p-8">
            <header class="mb-6 border-b pb-4">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-800 text-center">INPT ро╡ро╛роХрпНроХро╛ро│ро░рпН рокроЯрпНроЯро┐ропро▓рпН</h1>
                <p class="text-center text-grey-300 mt-1">ро╡ро┐ро╡ро░роЩрпНроХро│рпИрокрпН рокро╛ро░рпНроХрпНроХ, родрпЗроЯ ро╡роХрпИропро░ро╛/роорпКрокрпИро▓рпН роОрогрпН/роорпБроХро╡ро░ро┐ропрпИ роЙро│рпНро│рпАроЯрпБ роЪрпЖропрпНроп</p>
            </header>

            <div class="mb-6 p-4 bg-blue-50 rounded-lg shadow-inner">
                <label for="search-input" class="block text-lg font-semibold text-blue-600 mb-2">родрпЗроЯро▓рпН (рокрпЖропро░рпН, родро┐ро░рпБроорогрооро╛рой родрпЗродро┐ роЕро▓рпНро▓родрпБ ро╡ро░рпБроЯроорпН)</label>
                <input type="text" id="search-input" placeholder="рокрпЖропро░рпН/родрпЗродро┐ DD-MM-YYYY/роЖрогрпНроЯрпБ"
                       class="w-full p-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-540 transition"
                       oninput="filterRecords()">
            </div>

            <div id="status-message" class="text-center p-3 mb-4 text-sm font-medium text-gray-600 bg-yellow-100 rounded-lg hidden">
                родро░ро╡рпБ роПро▒рпНро▒рокрпНрокроЯрпБроХро┐ро▒родрпБ...
            </div>

            <div class="data-table-container" id="data-container">
                <table class="divide-y divide-gray-200">
                    <thead class="bg-blue-50 sticky top-0 shadow-sm z-10">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">ро╡ро░ро┐роЪрпИ роОрогрпН</th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">рокрпЖропро░рпН</th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">родроирпНродрпИ рокрпЖропро░рпН</th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">ро╡роХрпИропро░ро╛</th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">родро┐ро░рпБроорогрооро╛рой родрпЗродро┐</th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider hidden lg:table-cell">родро┐ро░рпБроорогрооро╛рой ро╡ро░рпБроЯроорпН</th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">родро┐ро░рпБроорогродрпНродро┐ройрпН рокрпЛродрпБ ро╡ропродрпБ</th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">родро▒рпНрокрпЛродрпИроп ро╡ропродрпБ</th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">роорпКрокрпИро▓рпН роироорпНрокро░рпН</th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">роорпБроХро╡ро░ро┐</th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">роЪрпЖропро▓рпН</th>
                        </tr>
                    </thead>
                    <tbody id="voter-details-body" class="bg-white divide-y divide-gray-100">
                        </tbody>
                </table>
                
                <div id="no-results" class="text-center py-12 text-gray-500 text-xl hidden">
                    родрпЗроЯро▓рпБроХрпНроХрпБ роПро▒рпНро▒ рокродро┐ро╡рпБроХро│рпН роОродрпБро╡рпБроорпН роЗро▓рпНро▓рпИ.
                </div>

                <div id="user-info" class="text-sm text-gray-400 mt-6 pt-4 border-t border-gray-200">
                    <p>рокропройро░рпН ID: <span id="current-user-id">роЗро▓рпНро▓рпИ</span></p>
                    <p class="text-xs text-red-500 mt-1">родро░ро╡рпИрокрпН рокродро┐ро╡рпЗро▒рпНро▒, роЙроЩрпНроХро│рпН роХрогро┐ройро┐ропро┐ро▓рпН роЙро│рпНро│ Node.js ро╕рпНроХро┐ро░ро┐рокрпНроЯрпИрокрпН рокропройрпНрокроЯрпБродрпНродро╡рпБроорпН.</p>
                </div>
            </div>
        </div>
    </div>
    <div id="update-modal" class="modal-overlay hidden">
        <div class="modal-content bg-white rounded-xl shadow-3xl p-6 relative">
            <h2 class="text-2xl font-bold text-indigo-700 mb-3 border-b pb-2">родрпКроЯро░рпНрокрпБ ро╡ро┐ро╡ро░роорпН рокродро┐роп</h2>
            
            <div id="view-details-container" class="space-y-3 p-4 mb-4 bg-gray-50 rounded-lg hidden">
                </div>
            <form id="update-form">
                <div class="mb-4">
                    <p id="update-name" class="text-lg font-semibold text-gray-900 bg-gray-50 p-2 rounded-lg"></p>
                    <input type="hidden" id="update-serial-no">
                    <input type="hidden" id="update-doc-id"> </div>
                
                <div id="modal-status-message-top" class="text-center p-3 mb-4 text-sm font-medium rounded-lg hidden"></div>
                
                <div class="mb-4">
                    <label for="update-relation" class="block text-sm font-medium text-gray-700 mb-1">ро╡роХрпИропро░ро╛ <span class="text-red-500">*</span></label>
                    <input type="text" id="update-relation" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>

                <div class="mb-4">
                    <label for="update-mobile" class="block text-sm font-medium text-gray-700 mb-1">роорпКрокрпИро▓рпН роироорпНрокро░рпН <span class="text-red-500">*</span></label>
                    <input type="tel" id="update-mobile" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>

                <div class="mb-6">
                    <label for="update-address" class="block text-sm font-medium text-gray-700 mb-1">роорпБроХро╡ро░ро┐ <span class="text-red-500">*</span></label>
                    <textarea id="update-address" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-none" required></textarea>
                </div>
                
                <div id="modal-status-message-bottom" class="text-center p-3 mb-4 text-sm font-medium rounded-lg hidden"></div>

                <div id="modal-form-buttons" class="flex justify-end space-x-4">
                    <button type="button" id="form-cancel-button" onclick="closeUpdateModal()" class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition duration-300">
                        ро░родрпНродрпБроЪрпЖропрпН
                    </button>
                    <button type="submit" id="save-button" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-300 shadow-md">
                        роЪрпЗрооро┐
                    </button>
                </div>
            </form>
            
            <div id="modal-view-buttons" class="flex justify-end pt-4 border-t border-gray-200 hidden">
                <button type="button" onclick="closeUpdateModal()" 
                        class="px-4 py-2 bg-red-300 text-white-800 font-semibold rounded-lg hover:bg-gray-400 transition duration-300">
                    роорпВроЯрпБ (CLOSE)
                </button>
            </div>
            </div>
    </div>


        <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, onAuthStateChanged, signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, onSnapshot, updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('debug');

        // ------------------------------------------------------------------------------------------
        // Firebase Configuration (USE YOUR ACTUAL CONFIG HERE)
        const firebaseConfig = {
            apiKey: "AIzaSyD5zu1YkYTy5AAGzs8tOVU4Mz5ZLxf87GE", 
            authDomain: "inptvotersdata.firebaseapp.com",
            projectId: "inptvotersdata", 
            storageBucket: "inptvotersdata.appspot.com",
            messagingSenderId: "772536734950",
            appId: "1:772536734950:web:8bc150658df00dc86c9727"
        };
        // ------------------------------------------------------------------------------------------

        let db;
        let auth;
        let globalRecords = [];
        let currentUserId = null;
        let totalVoters = 0; // NEW: To store the total count
        let mobileUpdatedCount = 0; // NEW: To store mobile updated count
        
        const COLLECTION_NAME = 'voterRecords'; 
        
        // тмЗя╕П SCROLL FIX: Disable browser's automatic scroll restoration тмЗя╕П
        if ('scrollRestoration' in history) {
            history.scrollRestoration = 'manual';
        }
        // тмЖя╕П END SCROLL FIX тмЖя╕П

        // DOM elements
        const statusMessageEl = document.getElementById('status-message');
        const voterDetailsBody = document.getElementById('voter-details-body');
        const noResultsEl = document.getElementById('no-results');
        const currentUserIdEl = document.getElementById('current-user-id');
        const updateModal = document.getElementById('update-modal');
        const updateForm = document.getElementById('update-form');
        const updateNameEl = document.getElementById('update-name');
        const updateSerialNoEl = document.getElementById('update-serial-no');
        const updateDocIdEl = document.getElementById('update-doc-id'); 
        const updateRelationEl = document.getElementById('update-relation');
        const updateMobileEl = document.getElementById('update-mobile');
        const updateAddressEl = document.getElementById('update-address');
        const saveButtonEl = document.getElementById('save-button');
        const modalStatusTopEl = document.getElementById('modal-status-message-top');
        const modalStatusBottomEl = document.getElementById('modal-status-message-bottom');
        
        // тмЗя╕П NEW DOM ELEMENTS FOR INTRO MODAL тмЗя╕П
        const voterInfoModal = document.getElementById('voterInfoModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const mainContent = document.getElementById('mainContent');
        const modalPercentEl = document.getElementById('modal-percent');
        // тмЖя╕П END NEW DOM ELEMENTS тмЖя╕П
        
        // тмЗя╕П DOM ELEMENTS FOR MODAL MODES тмЗя╕П
        const viewDetailsContainer = document.getElementById('view-details-container');
        const updateModalTitle = document.querySelector('#update-modal h2');
        const modalViewButtons = document.getElementById('modal-view-buttons'); 
        const modalFormButtons = document.getElementById('modal-form-buttons'); 
        // тмЖя╕П END DOM ELEMENTS тмЖя╕П


        // Helper function for styling read-only fields
        function toggleReadOnlyStyles(element, isReadOnly) {
            element.readOnly = isReadOnly;
            element.classList.toggle('bg-gray-100', isReadOnly);
            element.classList.toggle('bg-white', !isReadOnly);
        }

        // --- Utility Functions ---

        function showStatus(message, isError = false, element = statusMessageEl) {
            element.textContent = message;
            element.className = isError 
                ? 'text-center p-3 mb-4 text-sm font-medium text-red-700 bg-red-100 rounded-lg'
                : 'text-center p-3 mb-4 text-sm font-medium text-gray-600 bg-yellow-100 rounded-lg';
            element.classList.remove('hidden');
        }

        function hideStatus(element = statusMessageEl) {
            element.classList.add('hidden');
        }
        
        // Utility function to reset table scroll position
        function resetScrollPosition() {
            const dataContainer = document.getElementById('data-container');
            if (dataContainer) {
                // Set the vertical scroll position to 0 (top)
                dataContainer.scrollTop = 0;
            }
        }

        function getCollectionRef() {
            return collection(db, COLLECTION_NAME);
        }
        
        // тмЗя╕П NEW: Function to calculate and update percentage тмЗя╕П
        function updatePercentageDisplay(records) {
            totalVoters = records.length;
            mobileUpdatedCount = records.filter(r => r.mobileNo && r.mobileNo.trim() !== '').length;
            
            let percentage = 0;
            if (totalVoters > 0) {
                percentage = ((mobileUpdatedCount / totalVoters) * 100).toFixed(1);
            }
            
            // Update the percentage in the intro modal
            modalPercentEl.textContent = `${percentage}%`;
        }

        // тмЗя╕П NEW: Function to control intro modal visibility тмЗя╕П
        function closeModalAndShowMain() {
            voterInfoModal.style.display = "none";
            mainContent.style.display = "block";
        }
        
        // Attach listener to the continue button
        closeModalBtn.addEventListener('click', closeModalAndShowMain);
        
        // Initial state: Show modal, Hide main content (CSS handles modal display)
        mainContent.style.display = "none";
        // тмЖя╕П END NEW FUNCTIONS тмЖя╕П

        // --- Firebase Core Initialization and Data Listener ---

        async function initFirebase() {
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey.length < 30) { 
                showStatus("тЫФ рокро┐ро┤рпИ: Firebase API ро╡ро┐роЪрпИ роХро╛рогрокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ роЕро▓рпНро▓родрпБ родро╡ро▒ро╛роХ роЙро│рпНро│родрпБ.", true);
                return;
            }

            try {
                showStatus("роЕроЩрпНроХрпАроХро╛ро░роорпН рооро▒рпНро▒рпБроорпН родро░ро╡рпБродрпНродро│роорпН роПро▒рпНро▒рокрпНрокроЯрпБроХро┐ро▒родрпБ...");
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 1. Authenticate (Anonymous Sign-in) - CRITICAL FIX implemented here
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            currentUserId = user.uid;
                        } else {
                            try {
                                await signInAnonymously(auth); 
                                currentUserId = auth.currentUser.uid;
                            } catch (error) {
                                console.error("Authentication Error: Failed to sign in anonymously.", error);
                                
                                // тмЗя╕П CRITICAL FIX: Explicitly sign out to revoke the session on failure тмЗя╕П
                                try {
                                    await signOut(auth); // Use imported signOut function
                                    console.log("Previous anonymous session revoked successfully.");
                                } catch (signOutError) {
                                    console.error("Error revoking session:", signOutError);
                                }
                                // тмЖя╕П END CRITICAL FIX тмЖя╕П
                                
                                showStatus("роЕроЩрпНроХрпАроХро╛ро░ рокро┐ро┤рпИ: родро░ро╡рпИ роЕрогрпБроХ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ. Firebase Quota роЕро▓рпНро▓родрпБ родрпКроЯро░рпНрокрпБ роЪро┐роХрпНроХро▓рпН.", true);
                                currentUserId = 'anonymous-error';
                            }
                        }
                        // Correctly handle the display text for failed state
                        currentUserIdEl.textContent = (currentUserId === 'anonymous-error') ? 'роЗро▓рпНро▓рпИ' : currentUserId;
                        unsubscribe(); 
                        resolve();
                    });
                });
                
                // 2. Setup Data Listener
                setupDataListener();

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showStatus(`Firebase родрпБро╡роХрпНроХрокрпН рокро┐ро┤рпИ: ${error.message}`, true);
            }
        }

        function setupDataListener() {
            if (!db || !currentUserId || currentUserId === 'anonymous-error') {
                console.log("Database or User ID not ready for listener.");
                // Do not attempt to load data if authentication failed
                return; 
            }

            const collectionRef = getCollectionRef();
            
            onSnapshot(collectionRef, (querySnapshot) => {
                const records = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    records.push({
                        docId: doc.id, 
                        serialNo: Number(data.serialNo) || 0,
                        name: String(data.name || ''),
                        fatherName: String(data.fatherName || ''),
                        relation: String(data.relation || ''),
                        marriageDate: String(data.marriageDate || ''),
                        marriageYear: String(data.marriageYear || ''),
                        ageAtMarriage: Number(data.ageAtMarriage) || 0,
                        currentAge: Number(data.currentAge) || 0,
                        mobileNo: String(data.mobileNo || ''), 
                        address: String(data.address || '')
                    });
                });

                globalRecords = records.sort((a, b) => a.serialNo - b.serialNo);
                
                // тмЗя╕П NEW: Update percentage calculation here тмЗя╕П
                updatePercentageDisplay(globalRecords); 
                
                if (globalRecords.length > 0) {
                    filterRecords();
                    hideStatus();
                } else {
                    filterRecords();
                    showStatus("ро╡ро╛роХрпНроХро╛ро│ро░рпН рокродро┐ро╡рпБроХро│рпН роОродрпБро╡рпБроорпН роХро┐роЯрпИроХрпНроХро╡ро┐ро▓рпНро▓рпИ. родро░ро╡рпИрокрпН рокродро┐ро╡рпЗро▒рпНро▒ро╡рпБроорпН.", true);
                }
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                showStatus(`родро░ро╡рпБ роПро▒рпНро▒родрпНродро┐ро▓рпН рокро┐ро┤рпИ: ${error.message}`, true);
            });
        }
        
        // --- Modal and Update Logic (Edit Mode) ---
        
        function setUpdateModalState(record) {
            const mobileExists = record.mobileNo.trim() !== '';
            const addressExists = record.address.trim() !== '';
            const relationExists = record.relation.trim() !== ''; 
            
            // 1. Lock individual fields if data exists and apply styles
            toggleReadOnlyStyles(updateRelationEl, relationExists);
            toggleReadOnlyStyles(updateMobileEl, mobileExists);
            toggleReadOnlyStyles(updateAddressEl, addressExists);

            // 2. Check if ALL fields are complete (locked)
            const dataComplete = mobileExists && addressExists && relationExists; 

            if (dataComplete) {
                // All fields are filled and locked -> Disable save button
                saveButtonEl.disabled = true;
                saveButtonEl.classList.add('btn-disabled');
                showStatus("роЕройрпИродрпНродрпБродрпН родрпКроЯро░рпНрокрпБ ро╡ро┐ро╡ро░роЩрпНроХро│рпБроорпН роПро▒рпНроХройро╡рпЗ рокродро┐ропрокрпНрокроЯрпНроЯрпБро╡ро┐роЯрпНроЯрой. рокрпБродрпБрокрпНрокро┐роХрпНроХ роорпБроЯро┐ропро╛родрпБ.", true, modalStatusTopEl);
            } else {
                // At least one field is empty/editable -> Enable save button
                saveButtonEl.disabled = false;
                saveButtonEl.classList.remove('btn-disabled');
                hideStatus(modalStatusTopEl);
            }
        }
        
        window.openUpdateModal = function(serialNo) {
            const record = globalRecords.find(r => r.serialNo === serialNo);
            
            if (!record) {
                showStatus(`рокродро┐ро╡рпБ роОрогрпН ${serialNo} роХро╛рогрокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ.`, true);
                return;
            }

            // тмЗя╕П SWITCH TO EDIT MODE тмЗя╕П
            updateModalTitle.textContent = 'родрпКроЯро░рпНрокрпБ ро╡ро┐ро╡ро░роорпН рокродро┐роп';
            viewDetailsContainer.classList.add('hidden');    // Hide the view
            updateForm.classList.remove('hidden');           // Show the form
            modalViewButtons.classList.add('hidden');        // Hide view button set
            modalFormButtons.classList.remove('hidden');     // Show form button set
            // тмЖя╕П END SWITCH тмЖя╕П

            // Populate modal fields
            updateNameEl.textContent = record.name;
            updateSerialNoEl.value = serialNo;
            updateDocIdEl.value = record.docId; 
            updateRelationEl.value = record.relation; 
            updateAddressEl.value = record.address;
            
            setUpdateModalState(record);

            // ----------------------------------------------------------------------
            // Masking Logic for Mobile No. (Applied to input value if readOnly)
            let mobileNoValue = record.mobileNo || '';
            const mobileIsReadOnly = updateMobileEl.readOnly; 

            if (mobileIsReadOnly && mobileNoValue.length >= 4) {
                // If the field is locked (data exists), display the masked version
                updateMobileEl.value = '******' + mobileNoValue.slice(-4);
            } else {
                // If the field is editable (data does not exist), display the full, unmasked value
                updateMobileEl.value = mobileNoValue;
            }
            // ----------------------------------------------------------------------
            
            hideStatus(modalStatusBottomEl);
            updateModal.classList.remove('hidden');
        }

        
        // тмЗя╕П NEW: View-Only Modal Functions (View Mode) with CORRECT Masking тмЗя╕П

        /**
         * Renders the record data vertically inside the modal, with CORRECT masking applied.
         */
        function setViewModelState(record) {
            
            // 1. Prepare Masked Mobile No.
            let rawMobileNo = record.mobileNo || '';
            let displayMobileNo = rawMobileNo;
            let mobileClassName = 'text-gray-900'; 
            
            if (rawMobileNo.length > 0) {
                mobileClassName = 'text-green-700 font-semibold';
                
                if (rawMobileNo.length >= 4) {
                    // CORRECTED LINE: Mask all but the last four digits
                    displayMobileNo = '******' + rawMobileNo.slice(-4);
                } else {
                    // If less than 4 digits, show the available digits
                    displayMobileNo = rawMobileNo; 
                }
            } else {
                displayMobileNo = 'рокродро┐ропро╡ро┐ро▓рпНро▓рпИ';
                mobileClassName = 'text-red-500';
            }


            const fieldMap = [
                { label: 'ро╡ро░ро┐роЪрпИ роОрогрпН', value: record.serialNo, className: 'text-base font-bold text-blue-800' },
                { label: 'рокрпЖропро░рпН', value: record.name, className: 'text-lg font-bold text-indigo-800' },
                { label: 'родроирпНродрпИ рокрпЖропро░рпН', value: record.fatherName },
                { label: 'ро╡роХрпИропро░ро╛', value: record.relation || 'рокродро┐ропро╡ро┐ро▓рпНро▓рпИ' },
                { label: 'родро┐ро░рпБроорогрооро╛рой родрпЗродро┐', value: record.marriageDate },
                { label: 'родро┐ро░рпБроорогрооро╛рой ро╡ро░рпБроЯроорпН', value: record.marriageYear },
                { label: 'родро┐ро░рпБроорогродрпНродро┐ройрпН рокрпЛродрпБ ро╡ропродрпБ', value: record.ageAtMarriage },
                { label: 'родро▒рпНрокрпЛродрпИроп ро╡ропродрпБ', value: record.currentAge },
                // Use the prepared, masked mobile number and its class
                { label: 'роорпКрокрпИро▓рпН роироорпНрокро░рпН', value: displayMobileNo, className: mobileClassName },
                { label: 'роорпБроХро╡ро░ро┐', value: record.address || 'рокродро┐ропро╡ро┐ро▓рпНро▓рпИ'}
            ];

            let html = '';
            fieldMap.forEach(field => {
                html += `
                    <div class="border-b pb-1">
                        <span class="text-sm font-medium text-gray-500">${field.label}:</span>
                        <p class="text-base text-gray-900 ${field.className || ''}">${field.value}</p>
                    </div>
                `;
            });
            viewDetailsContainer.innerHTML = html;
        }


        window.openViewModal = function(serialNo) {
            const record = globalRecords.find(r => r.serialNo === serialNo);
            if (!record) return;

            // 1. Set the Title and Content
            updateModalTitle.textContent = 'ро╡ро╛роХрпНроХро╛ро│ро░рпН роорпБро┤рпБ ро╡ро┐ро╡ро░роорпН';
            setViewModelState(record);
            
            // 2. Control Visibility: Show View, Hide Form
            viewDetailsContainer.classList.remove('hidden'); // Show the view
            updateForm.classList.add('hidden');           // Hide the editable form
            modalViewButtons.classList.remove('hidden');  // Show view button set
            modalFormButtons.classList.add('hidden');     // Hide form button set

            // 3. Open the Modal 
            updateModal.classList.remove('hidden');
        }
        // тмЖя╕П END NEW FUNCTIONS тмЖя╕П


        window.closeUpdateModal = function() {
            // 1. Hide the modal and reset the form
            updateModal.classList.add('hidden');
            updateForm.reset();
            
            // тмЗя╕П RESET MODAL STATE & SCROLL FIX тмЗя╕П
            viewDetailsContainer.classList.add('hidden'); // Hide the view container
            updateForm.classList.remove('hidden');      // Show the form container for next edit
            modalViewButtons.classList.add('hidden');   // Hide view button set
            modalFormButtons.classList.remove('hidden'); // Show form button set
            updateModalTitle.textContent = 'родрпКроЯро░рпНрокрпБ ро╡ро┐ро╡ро░роорпН рокродро┐роп'; // Revert title
            
            // Scroll Fix: Wait briefly, then reset the scroll AND force a re-render/filter.
            setTimeout(() => {
                resetScrollPosition();
                filterRecords(); 
            }, 50); 
            // тмЖя╕П END RESET & SCROLL FIX тмЖя╕П
        }
        

        updateForm.onsubmit = function(event) {
            event.preventDefault();
            // Only attempt to save if the button is NOT disabled
            if (!saveButtonEl.disabled) {
                saveUpdatedRecord();
            } else {
                 showStatus("роЗроирпНрод ро╡ро┐ро╡ро░роЩрпНроХро│рпИ роЙроЩрпНроХро│ро╛ро▓рпН рокрпБродрпБрокрпНрокро┐роХрпНроХ роорпБроЯро┐ропро╛родрпБ. роЕройрпИродрпНродрпБроорпН рокрпВроЯрпНроЯрокрпНрокроЯрпНроЯрпБро│рпНро│рой.", true, modalStatusTopEl);
            }
        }

        async function saveUpdatedRecord() {
            hideStatus(modalStatusBottomEl);
            
            const docId = updateDocIdEl.value; 
            
            // Validation (Unchanged)
            if (!updateRelationEl.readOnly && !updateRelationEl.value.trim()) {
                showStatus("ро╡роХрпИропро░ро╛ роХроЯрпНроЯро╛ропроорпН роиро┐ро░рокрпНрокрокрпНрокроЯ ро╡рпЗрогрпНроЯрпБроорпН.", true, modalStatusBottomEl);
                return;
            }
            if (!updateMobileEl.readOnly && !updateMobileEl.value.trim()) {
                showStatus("роорпКрокрпИро▓рпН роироорпНрокро░рпН роХроЯрпНроЯро╛ропроорпН роиро┐ро░рокрпНрокрокрпНрокроЯ ро╡рпЗрогрпНроЯрпБроорпН.", true, modalStatusBottomEl);
                return;
            }
            if (!updateAddressEl.readOnly && !updateAddressEl.value.trim()) {
                showStatus("роорпБроХро╡ро░ро┐ роХроЯрпНроЯро╛ропроорпН роиро┐ро░рокрпНрокрокрпНрокроЯ ро╡рпЗрогрпНроЯрпБроорпН.", true, modalStatusBottomEl);
                return;
            }

            const currentRecord = globalRecords.find(r => r.docId === docId);

            const updatedData = {
                relation: updateRelationEl.value.trim(), 
                // IMPORTANT: When saving, read the original unmasked number from currentRecord 
                // if the field is readOnly, otherwise read the value from the input.
                mobileNo: updateMobileEl.readOnly ? currentRecord.mobileNo : updateMobileEl.value.trim(),
                address: updateAddressEl.value.trim(),
                lastUpdatedOn: new Date().toISOString()
            };
            
            const changesDetected = 
                currentRecord.relation !== updatedData.relation ||
                currentRecord.mobileNo !== updatedData.mobileNo ||
                currentRecord.address !== updatedData.address;

            if (!changesDetected) {
                showStatus("роОроирпНрод рооро╛ро▒рпНро▒роЩрпНроХро│рпБроорпН роЪрпЖропрпНропрокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ.", false, modalStatusBottomEl);
                setTimeout(closeUpdateModal, 1000);
                return;
            }
            
            showStatus("родро░ро╡рпБ роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпБроХро┐ро▒родрпБ...", false, modalStatusBottomEl);
            
            const docRef = doc(db, COLLECTION_NAME, docId);

            try {
                await updateDoc(docRef, updatedData);

                showStatus("родрпКроЯро░рпНрокрпБ ро╡ро┐ро╡ро░роЩрпНроХро│рпН ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХрокрпН рокрпБродрпБрокрпНрокро┐роХрпНроХрокрпНрокроЯрпНроЯрой!", false, modalStatusBottomEl);
                
                setTimeout(() => {
                    closeUpdateModal();
                }, 1500);

            } catch (error) {
                console.error("Firestore Update Error:", error);
                showStatus(`роЪрпЗрооро┐рокрпНрокро┐ро▓рпН рокро┐ро┤рпИ роПро▒рпНрокроЯрпНроЯродрпБ: ${error.message}`, true, modalStatusBottomEl);
            }
        }

        // --- Filtering and Rendering Logic ---

        window.filterRecords = function() {
            const searchInput = document.getElementById('search-input').value.trim().toLowerCase();
            
            let filteredRecords = globalRecords;

            if (searchInput) {
                filteredRecords = globalRecords.filter(record => {
                    const nameMatch = record.name && record.name.toLowerCase().includes(searchInput);
                    const dateMatch = record.marriageDate && record.marriageDate.toLowerCase().includes(searchInput);
                    const yearMatch = record.marriageYear && record.marriageYear.toString().includes(searchInput);

                    return nameMatch || dateMatch || yearMatch;
                });
            }
            
            renderTable(filteredRecords);
        }
        
        function renderTable(records) {
            
            voterDetailsBody.innerHTML = '';
            
            if (records.length === 0) {
                noResultsEl.classList.remove('hidden');
                resetScrollPosition(); 
                return;
            }

            noResultsEl.classList.add('hidden');

            records.forEach(record => {
                const row = voterDetailsBody.insertRow();
                row.className = 'hover:bg-blue-50 transition duration-150 ease-in-out';

                // 1. Prepare Masked Mobile No.
                let displayMobileNo = record.mobileNo || '';
                if (displayMobileNo.length >= 4) {
                    // Mask all but the last four digits
                    displayMobileNo = '******' + displayMobileNo.slice(-4);
                }
                
                // 2. Prepare Shortened Address
                let displayAddress = record.address || '';
                const MAX_ADDRESS_LENGTH = 30; 
                if (displayAddress.length > MAX_ADDRESS_LENGTH) {
                    displayAddress = displayAddress.substring(0, MAX_ADDRESS_LENGTH) + '...';
                }

                // Data for each cell (order matches table headers)
                const dataFields = [
                    record.serialNo, // Index 0 (Clickable)
                    record.name,     // Index 1
                    record.fatherName,
                    record.relation,
                    record.marriageDate,
                    record.marriageYear,
                    record.ageAtMarriage,
                    record.currentAge,
                    displayMobileNo, // <-- USES MASKED VALUE
                    displayAddress   // <-- USES SHORTENED VALUE
                ];

                dataFields.forEach((field, index) => {
                    const cell = row.insertCell();
                    
                    // тмЗя╕П Clickable 'Serial Number' column (index 0) тмЗя╕П
                    if (index === 0) { 
                        cell.innerHTML = `<button onclick="openViewModal(${record.serialNo})" class="text-blue-600 hover:text-blue-800 font-semibold underline">${field || ''}</button>`;
                    } else {
                        cell.textContent = field || '';
                    }
                    // тмЖя╕П END UPDATED CLICKABLE LOGIC тмЖя╕П

                    cell.className = 'px-3 py-.5 whitespace-nowrap text-sm text-gray-700';
                    
                    // Apply hidden classes for responsiveness
                    if (index === 5) cell.classList.add('hidden', 'lg:table-cell'); // Marriage Year
                });
                
                // Action Button Cell
                const actionCell = row.insertCell();
                actionCell.className = 'px-3 py-.5 whitespace-nowrap text-sm font-medium';
                actionCell.innerHTML = `
                    <button onclick="openUpdateModal(${record.serialNo})" 
                            class="bg-green-500 text-white p-2 text-xs rounded-lg shadow-sm hover:bg-green-600 transition duration-150 transform hover:scale-105">
                        ро╡ро┐ро╡ро░роЩрпНроХро│рпН роЪрпЗро░рпНроХрпНроХ
                    </button>
                `;
            });
            
            resetScrollPosition(); 

        }

        window.onload = initFirebase;
    </script>

</body>
</html>

