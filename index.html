<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ஐஎன்பிடி வாக்காளர் விவரம்</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* ⬇️ NEW: Lock scrolling on the main window ⬇️ */
        html, body {
            height: 100%;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
       
        .data-table-container {
           /* Setting max-height ensures the outer container wraps nicely, 
           and scroll happens when content exceeds this size. */
           max-height: 75vh; 
           overflow-y: auto; /* Enable vertical scroll only when needed */
           overflow-x: hidden; /* Explicitly hide horizontal scroll */
           -webkit-overflow-scrolling: touch;
         }


        /* Style for Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        /* Disabled button style */
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-4 sm:p-8">
        <header class="mb-6 border-b pb-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-800 text-center">INPT வாக்காளர் பட்டியல்</h1>
            <p class="text-center text-grey-300 mt-1">விவரங்களைப் பார்க்க, தேட வகையரா/மொபைல் எண்/முகவரியை உள்ளீடு செய்ய</p>
        </header>

        <div class="mb-6 p-4 bg-blue-50 rounded-lg shadow-inner">
            <label for="search-input" class="block text-lg font-semibold text-blue-600 mb-2">தேடல் (பெயர், திருமணமான தேதி அல்லது வருடம்)</label>
            <input type="text" id="search-input" placeholder="பெயர்/தேதி DD-MM-YYYY/ஆண்டு"
                   class="w-full p-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-540 transition"
                   oninput="filterRecords()">
        </div>

        <div id="status-message" class="text-center p-3 mb-4 text-sm font-medium text-gray-600 bg-yellow-100 rounded-lg hidden">
            தரவு ஏற்றப்படுகிறது...
        </div>

        <div class="data-table-container" id="data-container">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-blue-50 sticky top-0 shadow-sm z-10">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">வரிசை எண்</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">பெயர்</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">தந்தை பெயர்</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">வகையரா</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">திருமணமான தேதி</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider hidden lg:table-cell">திருமணமான வருடம்</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">திருமணத்தின் போது வயது</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">தற்போதைய வயது</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">மொபைல் நம்பர்</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">முகவரி</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-blue-700 uppercase tracking-wider">செயல்</th>
                    </tr>
                </thead>
                <tbody id="voter-details-body" class="bg-white divide-y divide-gray-100">
                    </tbody>
            </table>
            
            <div id="no-results" class="text-center py-12 text-gray-500 text-xl hidden">
                தேடலுக்கு ஏற்ற பதிவுகள் எதுவும் இல்லை.
            </div>

            <div id="user-info" class="text-sm text-gray-400 mt-6 pt-4 border-t border-gray-200">
                <p>பயனர் ID: <span id="current-user-id">இல்லை</span></p>
                <p class="text-xs text-red-500 mt-1">தரவைப் பதிவேற்ற, உங்கள் கணினியில் உள்ள Node.js ஸ்கிரிப்டைப் பயன்படுத்தவும்.</p>
            </div>
        </div>
    </div>
    
    <div id="update-modal" class="modal-overlay hidden">
        <div class="modal-content bg-white rounded-xl shadow-3xl p-6 relative">
            <h2 class="text-2xl font-bold text-indigo-700 mb-3 border-b pb-2">தொடர்பு விவரம் பதிய</h2>
            
            <div id="view-details-container" class="space-y-3 p-4 mb-4 bg-gray-50 rounded-lg hidden">
                </div>
            <form id="update-form">
                <div class="mb-4">
                    <p id="update-name" class="text-lg font-semibold text-gray-900 bg-gray-50 p-2 rounded-lg"></p>
                    <input type="hidden" id="update-serial-no">
                    <input type="hidden" id="update-doc-id"> </div>
                
                <div id="modal-status-message-top" class="text-center p-3 mb-4 text-sm font-medium rounded-lg hidden"></div>
                
                <div class="mb-4">
                    <label for="update-relation" class="block text-sm font-medium text-gray-700 mb-1">வகையரா <span class="text-red-500">*</span></label>
                    <input type="text" id="update-relation" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>

                <div class="mb-4">
                    <label for="update-mobile" class="block text-sm font-medium text-gray-700 mb-1">மொபைல் நம்பர் <span class="text-red-500">*</span></label>
                    <input type="tel" id="update-mobile" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>

                <div class="mb-6">
                    <label for="update-address" class="block text-sm font-medium text-gray-700 mb-1">முகவரி <span class="text-red-500">*</span></label>
                    <textarea id="update-address" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-none" required></textarea>
                </div>
                
                <div id="modal-status-message-bottom" class="text-center p-3 mb-4 text-sm font-medium rounded-lg hidden"></div>

                <div id="modal-form-buttons" class="flex justify-end space-x-4">
                    <button type="button" id="form-cancel-button" onclick="closeUpdateModal()" class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition duration-300">
                        ரத்துசெய்
                    </button>
                    <button type="submit" id="save-button" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-300 shadow-md">
                        சேமி
                    </button>
                </div>
            </form>
            
            <div id="modal-view-buttons" class="flex justify-end pt-4 border-t border-gray-200 hidden">
                <button type="button" onclick="closeUpdateModal()" 
                        class="px-4 py-2 bg-red-300 text-white-800 font-semibold rounded-lg hover:bg-gray-400 transition duration-300">
                    மூடு (CLOSE)
                </button>
            </div>
            </div>
    </div>


        <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, onAuthStateChanged, signOut // Added signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, onSnapshot, updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('debug');

        // ------------------------------------------------------------------------------------------
        // Firebase Configuration (USE YOUR ACTUAL CONFIG HERE)
        const firebaseConfig = {
            apiKey: "AIzaSyD5zu1YkYTy5AAGzs8tOVU4Mz5ZLxf87GE", 
            authDomain: "inptvotersdata.firebaseapp.com",
            projectId: "inptvotersdata", 
            storageBucket: "inptvotersdata.appspot.com",
            messagingSenderId: "772536734950",
            appId: "1:772536734950:web:8bc150658df00dc86c9727"
        };
        // ------------------------------------------------------------------------------------------

        let db;
        let auth;
        let globalRecords = [];
        let currentUserId = null;
        
        const COLLECTION_NAME = 'voterRecords'; 
        
        // ⬇️ SCROLL FIX: Disable browser's automatic scroll restoration ⬇️
        if ('scrollRestoration' in history) {
            history.scrollRestoration = 'manual';
        }
        // ⬆️ END SCROLL FIX ⬆️

        // DOM elements
        const statusMessageEl = document.getElementById('status-message');
        const voterDetailsBody = document.getElementById('voter-details-body');
        const noResultsEl = document.getElementById('no-results');
        const currentUserIdEl = document.getElementById('current-user-id');
        const updateModal = document.getElementById('update-modal');
        const updateForm = document.getElementById('update-form');
        const updateNameEl = document.getElementById('update-name');
        const updateSerialNoEl = document.getElementById('update-serial-no');
        const updateDocIdEl = document.getElementById('update-doc-id'); 
        const updateRelationEl = document.getElementById('update-relation');
        const updateMobileEl = document.getElementById('update-mobile');
        const updateAddressEl = document.getElementById('update-address');
        const saveButtonEl = document.getElementById('save-button');
        const modalStatusTopEl = document.getElementById('modal-status-message-top');
        const modalStatusBottomEl = document.getElementById('modal-status-message-bottom');
        
        // ⬇️ DOM ELEMENTS FOR MODAL MODES ⬇️
        const viewDetailsContainer = document.getElementById('view-details-container');
        const updateModalTitle = document.querySelector('#update-modal h2');
        const modalViewButtons = document.getElementById('modal-view-buttons'); 
        const modalFormButtons = document.getElementById('modal-form-buttons'); 
        // ⬆️ END DOM ELEMENTS ⬆️


        // Helper function for styling read-only fields
        function toggleReadOnlyStyles(element, isReadOnly) {
            element.readOnly = isReadOnly;
            element.classList.toggle('bg-gray-100', isReadOnly);
            element.classList.toggle('bg-white', !isReadOnly);
        }

        // --- Utility Functions ---

        function showStatus(message, isError = false, element = statusMessageEl) {
            element.textContent = message;
            element.className = isError 
                ? 'text-center p-3 mb-4 text-sm font-medium text-red-700 bg-red-100 rounded-lg'
                : 'text-center p-3 mb-4 text-sm font-medium text-gray-600 bg-yellow-100 rounded-lg';
            element.classList.remove('hidden');
        }

        function hideStatus(element = statusMessageEl) {
            element.classList.add('hidden');
        }
        
        // Utility function to reset table scroll position
        function resetScrollPosition() {
            const dataContainer = document.getElementById('data-container');
            if (dataContainer) {
                // Set the vertical scroll position to 0 (top)
                dataContainer.scrollTop = 0;
            }
        }

        function getCollectionRef() {
            return collection(db, COLLECTION_NAME);
        }
        
        // --- Firebase Core Initialization and Data Listener ---

        async function initFirebase() {
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey.length < 30) { 
                showStatus("⛔ பிழை: Firebase API விசை காணப்படவில்லை அல்லது தவறாக உள்ளது.", true);
                return;
            }

            try {
                showStatus("அங்கீகாரம் மற்றும் தரவுத்தளம் ஏற்றப்படுகிறது...");
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 1. Authenticate (Anonymous Sign-in) - CRITICAL FIX implemented here
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            currentUserId = user.uid;
                        } else {
                            try {
                                await signInAnonymously(auth); 
                                currentUserId = auth.currentUser.uid;
                            } catch (error) {
                                console.error("Authentication Error: Failed to sign in anonymously.", error);
                                
                                // ⬇️ CRITICAL FIX: Explicitly sign out to revoke the session on failure ⬇️
                                try {
                                    await signOut(auth); // Use imported signOut function
                                    console.log("Previous anonymous session revoked successfully.");
                                } catch (signOutError) {
                                    console.error("Error revoking session:", signOutError);
                                }
                                // ⬆️ END CRITICAL FIX ⬆️
                                
                                showStatus("அங்கீகார பிழை: தரவை அணுக முடியவில்லை. Firebase Quota அல்லது தொடர்பு சிக்கல்.", true);
                                currentUserId = 'anonymous-error';
                            }
                        }
                        // Correctly handle the display text for failed state
                        currentUserIdEl.textContent = (currentUserId === 'anonymous-error') ? 'இல்லை' : currentUserId;
                        unsubscribe(); 
                        resolve();
                    });
                });
                
                // 2. Setup Data Listener
                setupDataListener();

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showStatus(`Firebase துவக்கப் பிழை: ${error.message}`, true);
            }
        }

        function setupDataListener() {
            if (!db || !currentUserId || currentUserId === 'anonymous-error') {
                console.log("Database or User ID not ready for listener.");
                // Do not attempt to load data if authentication failed
                return; 
            }

            const collectionRef = getCollectionRef();
            
            onSnapshot(collectionRef, (querySnapshot) => {
                const records = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    records.push({
                        docId: doc.id, 
                        serialNo: Number(data.serialNo) || 0,
                        name: String(data.name || ''),
                        fatherName: String(data.fatherName || ''),
                        relation: String(data.relation || ''),
                        marriageDate: String(data.marriageDate || ''),
                        marriageYear: String(data.marriageYear || ''),
                        ageAtMarriage: Number(data.ageAtMarriage) || 0,
                        currentAge: Number(data.currentAge) || 0,
                        mobileNo: String(data.mobileNo || ''), 
                        address: String(data.address || '')
                    });
                });

                globalRecords = records.sort((a, b) => a.serialNo - b.serialNo);
                
                if (globalRecords.length > 0) {
                    filterRecords();
                    hideStatus();
                } else {
                    filterRecords();
                    showStatus("வாக்காளர் பதிவுகள் எதுவும் கிடைக்கவில்லை. தரவைப் பதிவேற்றவும்.", true);
                }
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                showStatus(`தரவு ஏற்றத்தில் பிழை: ${error.message}`, true);
            });
        }
        
        // --- Modal and Update Logic (Edit Mode) ---
        
        function setUpdateModalState(record) {
            const mobileExists = record.mobileNo.trim() !== '';
            const addressExists = record.address.trim() !== '';
            const relationExists = record.relation.trim() !== ''; 
            
            // 1. Lock individual fields if data exists and apply styles
            toggleReadOnlyStyles(updateRelationEl, relationExists);
            toggleReadOnlyStyles(updateMobileEl, mobileExists);
            toggleReadOnlyStyles(updateAddressEl, addressExists);

            // 2. Check if ALL fields are complete (locked)
            const dataComplete = mobileExists && addressExists && relationExists; 

            if (dataComplete) {
                // All fields are filled and locked -> Disable save button
                saveButtonEl.disabled = true;
                saveButtonEl.classList.add('btn-disabled');
                showStatus("அனைத்துத் தொடர்பு விவரங்களும் ஏற்கனவே பதியப்பட்டுவிட்டன. புதுப்பிக்க முடியாது.", true, modalStatusTopEl);
            } else {
                // At least one field is empty/editable -> Enable save button
                saveButtonEl.disabled = false;
                saveButtonEl.classList.remove('btn-disabled');
                hideStatus(modalStatusTopEl);
            }
        }
        
        window.openUpdateModal = function(serialNo) {
            const record = globalRecords.find(r => r.serialNo === serialNo);
            
            if (!record) {
                showStatus(`பதிவு எண் ${serialNo} காணப்படவில்லை.`, true);
                return;
            }

            // ⬇️ SWITCH TO EDIT MODE ⬇️
            updateModalTitle.textContent = 'தொடர்பு விவரம் பதிய';
            viewDetailsContainer.classList.add('hidden');    // Hide the view
            updateForm.classList.remove('hidden');           // Show the form
            modalViewButtons.classList.add('hidden');        // Hide view button set
            modalFormButtons.classList.remove('hidden');     // Show form button set
            // ⬆️ END SWITCH ⬆️

            // Populate modal fields
            updateNameEl.textContent = record.name;
            updateSerialNoEl.value = serialNo;
            updateDocIdEl.value = record.docId; 
            updateRelationEl.value = record.relation; 
            updateAddressEl.value = record.address;
            
            setUpdateModalState(record);

            // ----------------------------------------------------------------------
            // Masking Logic for Mobile No. (Applied to input value if readOnly)
            let mobileNoValue = record.mobileNo || '';
            const mobileIsReadOnly = updateMobileEl.readOnly; 

            if (mobileIsReadOnly && mobileNoValue.length >= 4) {
                // If the field is locked (data exists), display the masked version
                updateMobileEl.value = '******' + mobileNoValue.slice(-4);
            } else {
                // If the field is editable (data does not exist), display the full, unmasked value
                updateMobileEl.value = mobileNoValue;
            }
            // ----------------------------------------------------------------------
            
            hideStatus(modalStatusBottomEl);
            updateModal.classList.remove('hidden');
        }

        
        // ⬇️ NEW: View-Only Modal Functions (View Mode) with CORRECT Masking ⬇️

        /**
         * Renders the record data vertically inside the modal, with CORRECT masking applied.
         */
        function setViewModelState(record) {
            
            // 1. Prepare Masked Mobile No.
            let rawMobileNo = record.mobileNo || '';
            let displayMobileNo = rawMobileNo;
            let mobileClassName = 'text-gray-900'; 
            
            if (rawMobileNo.length > 0) {
                mobileClassName = 'text-green-700 font-semibold';
                
                if (rawMobileNo.length >= 4) {
                    // CORRECTED LINE: Mask all but the last four digits
                    displayMobileNo = '******' + rawMobileNo.slice(-4);
                } else {
                    // If less than 4 digits, show the available digits
                    displayMobileNo = rawMobileNo; 
                }
            } else {
                displayMobileNo = 'பதியவில்லை';
                mobileClassName = 'text-red-500';
            }


            const fieldMap = [
                { label: 'வரிசை எண்', value: record.serialNo, className: 'text-base font-bold text-blue-800' },
                { label: 'பெயர்', value: record.name, className: 'text-lg font-bold text-indigo-800' },
                { label: 'தந்தை பெயர்', value: record.fatherName },
                { label: 'வகையரா', value: record.relation || 'பதியவில்லை' },
                { label: 'திருமணமான தேதி', value: record.marriageDate },
                { label: 'திருமணமான வருடம்', value: record.marriageYear },
                { label: 'திருமணத்தின் போது வயது', value: record.ageAtMarriage },
                { label: 'தற்போதைய வயது', value: record.currentAge },
                // Use the prepared, masked mobile number and its class
                { label: 'மொபைல் நம்பர்', value: displayMobileNo, className: mobileClassName },
                { label: 'முகவரி', value: record.address || 'பதியவில்லை'}
            ];

            let html = '';
            fieldMap.forEach(field => {
                html += `
                    <div class="border-b pb-1">
                        <span class="text-sm font-medium text-gray-500">${field.label}:</span>
                        <p class="text-base text-gray-900 ${field.className || ''}">${field.value}</p>
                    </div>
                `;
            });
            viewDetailsContainer.innerHTML = html;
        }


        window.openViewModal = function(serialNo) {
            const record = globalRecords.find(r => r.serialNo === serialNo);
            if (!record) return;

            // 1. Set the Title and Content
            updateModalTitle.textContent = 'வாக்காளர் முழு விவரம்';
            setViewModelState(record);
            
            // 2. Control Visibility: Show View, Hide Form
            viewDetailsContainer.classList.remove('hidden'); // Show the view
            updateForm.classList.add('hidden');           // Hide the editable form
            modalViewButtons.classList.remove('hidden');  // Show view button set
            modalFormButtons.classList.add('hidden');     // Hide form button set

            // 3. Open the Modal 
            updateModal.classList.remove('hidden');
        }
        // ⬆️ END NEW FUNCTIONS ⬆️


        window.closeUpdateModal = function() {
            // 1. Hide the modal and reset the form
            updateModal.classList.add('hidden');
            updateForm.reset();
            
            // ⬇️ RESET MODAL STATE & SCROLL FIX ⬇️
            viewDetailsContainer.classList.add('hidden'); // Hide the view container
            updateForm.classList.remove('hidden');      // Show the form container for next edit
            modalViewButtons.classList.add('hidden');   // Hide view button set
            modalFormButtons.classList.remove('hidden'); // Show form button set
            updateModalTitle.textContent = 'தொடர்பு விவரம் பதிய'; // Revert title
            
            // Scroll Fix: Wait briefly, then reset the scroll AND force a re-render/filter.
            setTimeout(() => {
                resetScrollPosition();
                filterRecords(); 
            }, 50); 
            // ⬆️ END RESET & SCROLL FIX ⬆️
        }
        

        updateForm.onsubmit = function(event) {
            event.preventDefault();
            // Only attempt to save if the button is NOT disabled
            if (!saveButtonEl.disabled) {
                saveUpdatedRecord();
            } else {
                 showStatus("இந்த விவரங்களை உங்களால் புதுப்பிக்க முடியாது. அனைத்தும் பூட்டப்பட்டுள்ளன.", true, modalStatusTopEl);
            }
        }

        async function saveUpdatedRecord() {
            hideStatus(modalStatusBottomEl);
            
            const docId = updateDocIdEl.value; 
            
            // Validation (Unchanged)
            if (!updateRelationEl.readOnly && !updateRelationEl.value.trim()) {
                showStatus("வகையரா கட்டாயம் நிரப்பப்பட வேண்டும்.", true, modalStatusBottomEl);
                return;
            }
            if (!updateMobileEl.readOnly && !updateMobileEl.value.trim()) {
                showStatus("மொபைல் நம்பர் கட்டாயம் நிரப்பப்பட வேண்டும்.", true, modalStatusBottomEl);
                return;
            }
            if (!updateAddressEl.readOnly && !updateAddressEl.value.trim()) {
                showStatus("முகவரி கட்டாயம் நிரப்பப்பட வேண்டும்.", true, modalStatusBottomEl);
                return;
            }

            const currentRecord = globalRecords.find(r => r.docId === docId);

            const updatedData = {
                relation: updateRelationEl.value.trim(), 
                // IMPORTANT: When saving, read the original unmasked number from currentRecord 
                // if the field is readOnly, otherwise read the value from the input.
                mobileNo: updateMobileEl.readOnly ? currentRecord.mobileNo : updateMobileEl.value.trim(),
                address: updateAddressEl.value.trim(),
                lastUpdatedOn: new Date().toISOString()
            };
            
            const changesDetected = 
                currentRecord.relation !== updatedData.relation ||
                currentRecord.mobileNo !== updatedData.mobileNo ||
                currentRecord.address !== updatedData.address;

            if (!changesDetected) {
                showStatus("எந்த மாற்றங்களும் செய்யப்படவில்லை.", false, modalStatusBottomEl);
                setTimeout(closeUpdateModal, 1000);
                return;
            }
            
            showStatus("தரவு சேமிக்கப்படுகிறது...", false, modalStatusBottomEl);
            
            const docRef = doc(db, COLLECTION_NAME, docId);

            try {
                await updateDoc(docRef, updatedData);

                showStatus("தொடர்பு விவரங்கள் வெற்றிகரமாகப் புதுப்பிக்கப்பட்டன!", false, modalStatusBottomEl);
                
                setTimeout(() => {
                    closeUpdateModal();
                }, 1500);

            } catch (error) {
                console.error("Firestore Update Error:", error);
                showStatus(`சேமிப்பில் பிழை ஏற்பட்டது: ${error.message}`, true, modalStatusBottomEl);
            }
        }

        // --- Filtering and Rendering Logic ---

        window.filterRecords = function() {
            const searchInput = document.getElementById('search-input').value.trim().toLowerCase();
            
            let filteredRecords = globalRecords;

            if (searchInput) {
                filteredRecords = globalRecords.filter(record => {
                    const nameMatch = record.name && record.name.toLowerCase().includes(searchInput);
                    const dateMatch = record.marriageDate && record.marriageDate.toLowerCase().includes(searchInput);
                    const yearMatch = record.marriageYear && record.marriageYear.toString().includes(searchInput);

                    return nameMatch || dateMatch || yearMatch;
                });
            }
            
            renderTable(filteredRecords);
        }
        
        function renderTable(records) {
            
            voterDetailsBody.innerHTML = '';
            
            if (records.length === 0) {
                noResultsEl.classList.remove('hidden');
                resetScrollPosition(); 
                return;
            }

            noResultsEl.classList.add('hidden');

            records.forEach(record => {
                const row = voterDetailsBody.insertRow();
                row.className = 'hover:bg-blue-50 transition duration-150 ease-in-out';

                // 1. Prepare Masked Mobile No.
                let displayMobileNo = record.mobileNo || '';
                if (displayMobileNo.length >= 4) {
                    // Mask all but the last four digits
                    displayMobileNo = '******' + displayMobileNo.slice(-4);
                }
                
                // 2. Prepare Shortened Address
                let displayAddress = record.address || '';
                const MAX_ADDRESS_LENGTH = 30; 
                if (displayAddress.length > MAX_ADDRESS_LENGTH) {
                    displayAddress = displayAddress.substring(0, MAX_ADDRESS_LENGTH) + '...';
                }

                // Data for each cell (order matches table headers)
                const dataFields = [
                    record.serialNo, // Index 0 (Clickable)
                    record.name,     // Index 1
                    record.fatherName,
                    record.relation,
                    record.marriageDate,
                    record.marriageYear,
                    record.ageAtMarriage,
                    record.currentAge,
                    displayMobileNo, // <-- USES MASKED VALUE
                    displayAddress   // <-- USES SHORTENED VALUE
                ];

                dataFields.forEach((field, index) => {
                    const cell = row.insertCell();
                    
                    // ⬇️ Clickable 'Serial Number' column (index 0) ⬇️
                    if (index === 0) { 
                        cell.innerHTML = `<button onclick="openViewModal(${record.serialNo})" class="text-blue-600 hover:text-blue-800 font-semibold underline">${field || ''}</button>`;
                    } else {
                        cell.textContent = field || '';
                    }
                    // ⬆️ END UPDATED CLICKABLE LOGIC ⬆️

                    cell.className = 'px-3 py-.5 whitespace-nowrap text-sm text-gray-700';
                    
                    // Apply hidden classes for responsiveness
                    if (index === 5) cell.classList.add('hidden', 'lg:table-cell'); // Marriage Year
                });
                
                // Action Button Cell
                const actionCell = row.insertCell();
                actionCell.className = 'px-3 py-.5 whitespace-nowrap text-sm font-medium';
                actionCell.innerHTML = `
                    <button onclick="openUpdateModal(${record.serialNo})" 
                            class="bg-green-500 text-white p-2 text-xs rounded-lg shadow-sm hover:bg-green-600 transition duration-150 transform hover:scale-105">
                        விவரங்கள் சேர்க்க
                    </button>
                `;
            });
            
            resetScrollPosition(); 

        }

        window.onload = initFirebase;
    </script>

</body>
</html>

















